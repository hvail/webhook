/***
 * BSR 指的是 Batch, Single, Range 三种常用接口， 这里用一个函数进行解决
 * Created by hvail on 2018/10/16.
 */

const apiUtil = require('./utils');
const {RES_MASTER_HOST, RES_REDIS_HOST, RES_OTS_HOST} = apiUtil;

const ParseTime = (obj, tk) => {
    if (obj[tk] > (new Date().getTime() / 10))
        obj[tk] = Math.round(obj[tk] / 1000);
    return obj;
};

const ParseTimeArr = (arr, tk) => {
    for (let i = 0; i < arr.length; i++) {
        arr[i] = ParseTime(arr[i], tk);
    }
    return arr;
};

const _doSupportBSR = (router, fn, tk) => {
    let _getSingle = function (req, res, next) {
        let {sn} = req.params;
        apiUtil.PromiseGet(`${RES_REDIS_HOST}/${fn}/single/${sn}`)
            .then(msg => (JSON.parse(msg)))
            .then(obj => (ParseTime(obj, tk)))
            .then(obj => res.send(obj))
            .catch(e => {
                console.log(`${fn} index _getSingle ERROR`);
                console.log(e);
                res.send("");
            })
    };

    let _getRangeArrays = function (req, res, next) {
        let {sn, start, end} = req.params;
        apiUtil.PromiseGet(`${RES_OTS_HOST}/${fn}/range/${sn}/${start}/${end}`)
            .then(msg => (JSON.parse(msg)))
            .then(arr => (ParseTimeArr(arr, tk)))
            .then(obj => res.send(obj))
            .catch(e => {
                console.log(`${fn} index _getRangeArrays ERROR`);
                console.log(e);
                res.send("[]");
            });
    };

    let _getBatchArrays = function (req, res, next) {
        let sns = req.params.sns;
        apiUtil.PromiseGet(`${RES_REDIS_HOST}/${fn}/batch/${sns}`)
            .then(msg => (JSON.parse(msg)))
            .then(arr => (ParseTimeArr(arr, tk)))
            .then(obj => res.send(obj))
            .catch(e => {
                console.log(`${fn} index _getBatchArrays ERROR`);
                console.log(e);
                res.send("[]");
            });
    };

    router.get('/single/:sn', _getSingle);
    router.get('/range/:sn/:start/:end', _getRangeArrays);
    router.get('/batch/:sns', _getBatchArrays);
};

module.exports = _doSupportBSR;