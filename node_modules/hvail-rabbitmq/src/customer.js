/**
 * Created by hvail on 2018/9/6.
 **/
let mq = require('amqplib');

function Custom(host, user, pwd, initCb) {
    this.channel = null;
    let me = this;
    let url = `amqp://${user}:${pwd}@${host}:5672?heartbeat=10&connection_timeout=10000`;
    mq.connect(url).then(conn => (conn.createChannel()))
        .then(function (ch) {
            me.channel = ch;
            initCb && initCb(me);
        })
}

Custom.prototype.listen = function (exchange, name, listenCb) {
    let ch = this.channel;
    let queue = `${exchange}.${name}`;
    ch.assertQueue(queue, {autoDelete: true});
    ch.bindQueue(queue, exchange, `${exchange}.#`);
    ch.consume(queue, (msg) => (listenCb && listenCb(msg)), {noAck: true});
};

module.exports = Custom;
// ===================================================================================

// let listen = (msg) => {
//     let arr = JSON.parse(msg.content.toString());
//     console.log(arr);
// };
//
// let custom = new Custom("119.23.27.9", "hvail", "hvail", function () {
//     custom.listen("hyz.fanout.event", "test", listen);
// });
